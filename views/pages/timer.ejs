<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чек-таймер - CRM</title>
    <link rel="stylesheet" href="/styles/all.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            color: #333;
            font-size: 24px;
        }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .nav {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .nav-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .timer-card {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 30px;
        }
        .timer-display {
            font-size: 72px;
            font-weight: bold;
            color: #667eea;
            margin: 30px 0;
        }
        .timer-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        .btn {
            padding: 15px 30px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-start {
            background: #4caf50;
            color: white;
        }
        .btn-stop {
            background: #f44336;
            color: white;
        }
        .btn-break {
            background: #ff9800;
            color: white;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        .sessions-table {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Чек-таймер</h1>
    </div>

    <div class="container">
        <div class="nav">
            <a href="/dashboard" class="nav-btn">Главная</a>
            <a href="/clients" class="nav-btn">Клиенты</a>
            <a href="/olympiads" class="nav-btn">Олимпиады</a>
            <a href="/timer" class="nav-btn">Таймер</a>
            <a href="/reports" class="nav-btn">Отчеты</a>
            <a href="/employees" class="nav-btn" id="navEmployees" style="display: none;">Сотрудники</a>
            <a href="/profile" class="nav-btn">Профиль</a>
        </div>

        <div class="timer-card">
            <h2>Текущая сессия</h2>
            <div class="timer-display" id="timerDisplay">00:00:00</div>
            <div id="statusText" style="color: #666; margin-bottom: 20px;">Не начата</div>
            <div class="timer-controls">
                <button class="btn btn-start" id="startBtn" onclick="startTimer()">Start</button>
                <button class="btn btn-stop" id="stopBtn" onclick="stopTimer()" disabled>Stop</button>
                <button class="btn btn-break" id="breakBtn" onclick="takeBreak()" disabled>Break</button>
            </div>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>Сегодня</h3>
                <div class="value" id="todayHours">0 ч</div>
            </div>
            <div class="stat-card">
                <h3>Эта неделя</h3>
                <div class="value" id="weekHours">0 ч</div>
            </div>
            <div class="stat-card">
                <h3>Перерывов сегодня</h3>
                <div class="value" id="breaksCount">0</div>
            </div>
        </div>

        <div class="sessions-table">
            <h2 style="margin-bottom: 20px;">Последние сессии</h2>
            <table>
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Начало</th>
                        <th>Конец</th>
                        <th>Длительность</th>
                        <th>Перерывы</th>
                    </tr>
                </thead>
                <tbody id="sessionsTableBody">
                    <tr><td colspan="5" style="text-align: center;">Загрузка...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!token) window.location.href = '/login';

        // Показать ссылку на сотрудников для директора и зам. директора
        if (user.role === 'director' || user.role === 'vice_director') {
            document.getElementById('navEmployees').style.display = 'inline-block';
        }

        let timerInterval = null;
        let currentSession = null;

        async function loadCurrentSession() {
            try {
                const response = await fetch('/api/timer/current', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.active && data.session) {
                    currentSession = data.session;
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('breakBtn').disabled = false;
                    document.getElementById('statusText').textContent = 'Активна';
                    startTimerDisplay();
                } else {
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('breakBtn').disabled = true;
                    document.getElementById('statusText').textContent = 'Не начата';
                    document.getElementById('timerDisplay').textContent = '00:00:00';
                }
            } catch (error) {
                console.error('Error loading session:', error);
            }
        }

        function startTimerDisplay() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (!currentSession) return;
                
                const now = new Date();
                const start = new Date(currentSession.start_at);
                const breakDuration = (currentSession.break_duration || 0) * 60000;
                const elapsed = now - start - breakDuration;
                
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('timerDisplay').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        async function startTimer() {
            try {
                const response = await fetch('/api/timer/start', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    loadCurrentSession();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Ошибка при запуске таймера');
                }
            } catch (error) {
                console.error('Error starting timer:', error);
                alert('Ошибка при запуске таймера');
            }
        }

        async function stopTimer() {
            try {
                const response = await fetch('/api/timer/stop', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    if (timerInterval) clearInterval(timerInterval);
                    currentSession = null;
                    loadCurrentSession();
                    loadStats();
                    loadSessions();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Ошибка при остановке таймера');
                }
            } catch (error) {
                console.error('Error stopping timer:', error);
                alert('Ошибка при остановке таймера');
            }
        }

        async function takeBreak() {
            const duration = prompt('Длительность перерыва в минутах:', '15');
            if (!duration) return;

            try {
                const response = await fetch('/api/timer/break', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ duration_minutes: parseInt(duration) })
                });
                
                if (response.ok) {
                    loadCurrentSession();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Ошибка при фиксации перерыва');
                }
            } catch (error) {
                console.error('Error taking break:', error);
                alert('Ошибка при фиксации перерыва');
            }
        }

        async function loadStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const [todayRes, weekRes] = await Promise.all([
                    fetch(`/api/timer/report?date_from=${today}&date_to=${today}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`/api/timer/report?date_from=${weekAgo}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                const todayData = await todayRes.json();
                const weekData = await weekRes.json();

                document.getElementById('todayHours').textContent = 
                    (todayData.statistics?.total_hours || 0).toFixed(1) + ' ч';
                document.getElementById('weekHours').textContent = 
                    (weekData.statistics?.total_hours || 0).toFixed(1) + ' ч';
                document.getElementById('breaksCount').textContent = 
                    todayData.statistics?.total_sessions || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadSessions() {
            try {
                const response = await fetch('/api/timer/report?limit=10', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                displaySessions(data.sessions || []);
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        function displaySessions(sessions) {
            const tbody = document.getElementById('sessionsTableBody');
            if (sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Сессии не найдены</td></tr>';
                return;
            }

            tbody.innerHTML = sessions.map(session => {
                const start = new Date(session.start_at);
                const end = session.end_at ? new Date(session.end_at) : null;
                const hours = ((session.duration_minutes || 0) / 60).toFixed(1);
                
                return `
                    <tr>
                        <td>${start.toLocaleDateString('ru-RU')}</td>
                        <td>${start.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</td>
                        <td>${end ? end.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                        <td>${hours} ч</td>
                        <td>${session.break_duration || 0} мин</td>
                    </tr>
                `;
            }).join('');
        }

        loadCurrentSession();
        loadStats();
        loadSessions();
    </script>
</body>
</html>

